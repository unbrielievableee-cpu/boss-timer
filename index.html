<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EscobarPH Boss Timers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { background: #020617; color: #e5e7eb; padding: 24px; min-height: 100vh; }
    .page { max-width: 1180px; margin: 0 auto; }

    h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .subtitle { font-size: 13px; color: #9ca3af; margin-bottom: 16px; }

    .hero {
      margin-bottom: 24px; padding: 10px 16px; border-radius: 999px;
      display: flex; align-items: center; gap: 8px;
      background: radial-gradient(circle at top left, #22c55e33, #0b1120);
      border: 1px solid #16a34a55; font-size: 13px; color: #bbf7d0;
      min-height: 34px;
    }
    .hero-label { font-weight: 600; background: #16a34a22; padding: 3px 8px; border-radius: 999px; }
    .hero-strong { font-weight: 600; color: #f9fafb; }

    .section-title { font-size: 15px; font-weight: 600; margin: 18px 0 8px; }

    .table-card {
      background: #020617; border-radius: 14px; border: 1px solid #111827;
      box-shadow: 0 18px 45px rgba(15,23,42,0.9);
      padding: 12px 16px 16px; overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th {
      text-align: left; padding: 8px 6px; font-size: 11px; text-transform: uppercase;
      color: #6b7280; border-bottom: 1px solid #1f2937; white-space: nowrap;
    }
    tbody td { padding: 7px 6px; border-bottom: 1px solid #0f172a; white-space: nowrap; }

    .td-name { font-weight: 600; }
    .td-muted { color: #9ca3af; }

    .badge-respawn { padding: 2px 8px; border-radius: 999px; font-size: 11px; border: 1px solid #1f2937; }
    .badge-dynamic { color: #bfdbfe; border-color: #3b82f6; }
    .badge-fixed { color: #fed7aa; border-color: #f97316; }

    .countdown { font-variant-numeric: tabular-nums; font-size: 13px; font-weight: 600; }
    .countdown-soft { color: #9ca3af; }

    .btn { border-radius: 999px; padding: 5px 10px; font-size: 12px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: #fff; }
    .btn-secondary { background: #0f172a; color: #e5e7eb; border: 1px solid #1f2937; }

    .controls { display: flex; gap: 6px; justify-content: flex-end; }

    .highlight-10m { background: rgba(255,165,0,0.25) !important; }
    .highlight-5m { background: rgba(255,0,0,0.25) !important; }
  </style>
</head>
<body>
  <div class="page">

    <h1>EscobarPH Boss Timers</h1>
    <div class="subtitle">Dynamic bosses store death times automatically.</div>

    <div id="hero" class="hero">
      <span class="hero-label">Next respawn</span>
      <span id="hero-text">Loading…</span>
    </div>

    <div id="error" class="error" style="display:none;"></div>

    <!-- DYNAMIC BOSSES -->
    <div class="section-title">Dynamic Respawns (Kill-Based)</div>
    <div class="table-card" style="margin-bottom:18px;">
      <table>
        <thead>
          <tr>
            <th>Boss Name</th>
            <th>Respawn</th>
            <th>Time of Death</th>
            <th>Next Respawn</th>
            <th>Countdown</th>
            <th>Head to Boss Area</th>
            <th class="center">Controls</th>
          </tr>
        </thead>
        <tbody id="dynamic-body"></tbody>
      </table>
    </div>

    <!-- FIXED BOSSES -->
    <div class="section-title">Fixed Schedule Bosses</div>
    <div class="table-card">
      <table>
        <thead>
          <tr>
            <th>Boss Name</th>
            <th>Schedule</th>
            <th>Next Spawn</th>
            <th>Countdown</th>
            <th class="center">Controls</th>
          </tr>
        </thead>
        <tbody id="fixed-body"></tbody>
      </table>
    </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyMxe_s06Cwp4ZqJmDKFEjU5bjLlNZ2xC55I2BK7OZKAGRaQiWbCxqG73FyLaDxoIr6/exec";

    const WEEKDAY_INDEX = {Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6};

    let bossesRaw=[], bossesDynamic=[], bossesFixed=[];

    const HEAD_OFFSET_MS = 5*60*1000;
    const EXPIRE_OFFSET_MS = 2*60*1000;

    function formatCountdown(ms){
      if(ms<=0)return"00h 00m 00s";
      let s=Math.floor(ms/1000), h=Math.floor(s/3600);
      s%=3600; let m=Math.floor(s/60); s%=60;
      const pad=n=>String(n).padStart(2,"0");
      return `${pad(h)}h ${pad(m)}m ${pad(s)}s`;
    }

    function formatDateTime(dt){
      return dt && !isNaN(dt) ? dt.toLocaleString() : "—";
    }

    function formatSchedule(b){
      const p1 = b.fixed_day_1? `${b.fixed_day_1} ${b.fixed_time_1_24h}`:"";
      const p2 = b.fixed_day_2? `${b.fixed_day_2} ${b.fixed_time_2_24h}`:"";
      return p1 && p2 ? `${p1}, ${p2}` : p1 || p2 || "—";
    }

    function nextWeekly(day, time, now){
      const [H,M] = time.split(":").map(Number);
      let d=new Date(now);
      let target=WEEKDAY_INDEX[day];
      let delta=(target-now.getDay()+7)%7;
      d.setDate(d.getDate()+delta);
      d.setHours(H,M,0,0);
      if(d<=now) d.setDate(d.getDate()+7);
      return d;
    }

    function compute(b){
      const now=new Date();
      if(b.respawn_type==="dynamic"){
        if(!b.last_death_iso) return null;
        return new Date(new Date(b.last_death_iso).getTime() + b.respawn_hours*3600000);
      }
      let arr=[];
      if(b.fixed_day_1) arr.push(nextWeekly(b.fixed_day_1,b.fixed_time_1_24h,now));
      if(b.fixed_day_2) arr.push(nextWeekly(b.fixed_day_2,b.fixed_time_2_24h,now));
      return arr.length? arr.sort((a,b)=>a-b)[0] : null;
    }

    function enrich(){
      bossesDynamic=[]; bossesFixed=[];
      bossesRaw.forEach(b=>{
        let o={...b};
        o.nextRespawn=compute(o);
        if(o.respawn_type==="dynamic") bossesDynamic.push(o);
        else bossesFixed.push(o);
      });
    }

    function render(){
      const dyn=document.getElementById("dynamic-body");
      const fix=document.getElementById("fixed-body");
      dyn.innerHTML=""; fix.innerHTML="";

      bossesDynamic.forEach(b=>{
        dyn.innerHTML+=`
          <tr data-boss-name="${b.boss_name}">
            <td class="td-name">${b.boss_name}</td>
            <td><span class="badge-respawn badge-dynamic">${b.respawn_hours}h</span></td>
            <td class="td-muted">${formatDateTime(new Date(b.last_death_iso))}</td>
            <td class="td-muted">${formatDateTime(b.nextRespawn)}</td>
            <td><span data-role="countdown-main">--</span></td>
            <td><span data-role="countdown-head">--</span></td>
            <td class="center">
              <div class="controls">
                <button class="btn btn-primary" data-action="death" data-boss="${b.boss_name}">Death now</button>
                <button class="btn btn-secondary" data-action="clear" data-boss="${b.boss_name}">Clear</button>
              </div>
            </td>
          </tr>`;
      });

      bossesFixed.forEach(b=>{
        fix.innerHTML+=`
          <tr data-boss-name="${b.boss_name}">
            <td class="td-name">${b.boss_name} <span class="badge-respawn badge-fixed">Fixed</span></td>
            <td class="td-muted">${formatSchedule(b)}</td>
            <td class="td-muted">${formatDateTime(b.nextRespawn)}</td>
            <td><span data-role="countdown-main">--</span></td>
            <td class="center td-muted">—</td>
          </tr>`;
      });

      attachControls();
    }

    function updateHero(){
      const now=new Date();
      let future=bossesDynamic.concat(bossesFixed)
        .filter(b=>b.nextRespawn>now)
        .sort((a,b)=>a.nextRespawn-b.nextRespawn);

      const el=document.getElementById("hero-text");
      if(!future.length){ el.textContent="No upcoming respawns."; return; }

      let b=future[0], ms=b.nextRespawn-now;
      el.innerHTML=`<span class="hero-strong">${b.boss_name}</span> respawns in <span class="hero-strong">${formatCountdown(ms)}</span> at <span class="hero-strong">${formatDateTime(b.nextRespawn)}</span>`;
    }

    function countdown(){
      const now=new Date();
      bossesDynamic.forEach(b=>{
        let row=document.querySelector(`tr[data-boss-name="${b.boss_name}"]`);
        if(!row) return;
        const ms=b.nextRespawn-now, head=ms-HEAD_OFFSET_MS;
        row.querySelector('[data-role="countdown-main"]').textContent=formatCountdown(ms);
        row.querySelector('[data-role="countdown-head"]').textContent=formatCountdown(head);

        row.classList.remove("highlight-10m","highlight-5m");
        let mins=head/60000;
        if(mins<5)row.classList.add("highlight-5m");
        else if(mins<10)row.classList.add("highlight-10m");
      });

      bossesFixed.forEach(b=>{
        let row=document.querySelector(`tr[data-boss-name="${b.boss_name}"]`);
        if(!row) return;
        row.querySelector('[data-role="countdown-main"]').textContent=formatCountdown(b.nextRespawn-now);
      });

      updateHero();
    }

    function attachControls(){
      document.querySelectorAll("[data-action]").forEach(btn=>{
        btn.onclick=()=>{
          const boss=btn.dataset.boss;
          const act=btn.dataset.action;
          send(boss,act);
        };
      });
    }

    async function send(name,action){
      const body={action,boss_name:name};
      if(action==="update") body.last_death_iso=new Date().toISOString();
      await fetch(API_URL,{method:"POST",body:JSON.stringify(body)});
      load();
    }

    async function load(){
      const res=await fetch(API_URL);
      const data=await res.json();
      bossesRaw=data.bosses;
      enrich();
      render();
    }

    load();
    setInterval(load, 10000);   // FETCH EVERY 10 SECONDS
    setInterval(countdown, 1000);
  </script>
</body>
</html>
